{% extends "base.html" %}

{% block title %}Existing Products - Product Adder{% endblock %}

{% block extra_head %}
<style>
    .product-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: white;
        transition: all 0.3s ease;
    }
    
    .product-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .product-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    
    .product-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin: 0;
        flex: 1;
    }
    
    .product-sku {
        background: #e9ecef;
        color: #495057;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .product-image {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 20px;
        border: 1px solid #e0e0e0;
    }
    
    .product-content {
        display: flex;
        margin-bottom: 15px;
    }
    
    .product-details {
        flex: 1;
    }
    
    .product-description {
        color: #666;
        margin-bottom: 10px;
        line-height: 1.5;
    }
    
    .pricing-comparison {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }
    
    .pricing-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }
    
    .price-comparison-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .price-comparison-item {
        text-align: center;
        padding: 12px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
    }
    
    .price-comparison-item.current {
        background: #e3f2fd;
        border-color: #2196f3;
    }
    
    .price-comparison-item.recommended {
        background: #e8f5e8;
        border-color: #4caf50;
    }
    
    .price-comparison-item.clickable-price {
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .price-comparison-item.clickable-price:hover {
        background: #d4edda;
        border-color: #28a745;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }
    
    .price-comparison-item.clickable-price:active {
        transform: translateY(0);
        box-shadow: 0 1px 4px rgba(40, 167, 69, 0.3);
    }
    
    .price-hint {
        font-size: 0.7rem;
        color: #28a745;
        margin-top: 2px;
        font-weight: 500;
        opacity: 0.8;
    }
    
    .price-comparison-item.clickable-price:hover .price-hint {
        opacity: 1;
    }
    
    .price-label {
        font-size: 0.75rem;
        color: #666;
        margin-bottom: 4px;
        font-weight: 500;
    }
    
    .price-value {
        font-weight: 600;
        color: #333;
        font-size: 1.1rem;
    }
    
    .price-difference {
        font-size: 0.875rem;
        margin-top: 4px;
    }
    
    .price-difference.positive {
        color: #28a745;
    }
    
    .price-difference.negative {
        color: #dc3545;
    }
    
    .price-difference.neutral {
        color: #6c757d;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .status-badge.accurate {
        background: #d4edda;
        color: #155724;
    }
    
    .status-badge.underpriced {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-badge.overpriced {
        background: #f8d7da;
        color: #721c24;
    }
    
    .search-filters {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 200px;
    }
    
    .filter-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
    }
    
    .stats-bar {
        background: #e9ecef;
        padding: 10px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .no-products {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    
    .no-products h3 {
        margin-bottom: 10px;
        color: #333;
    }
    
    @media (max-width: 768px) {
        .product-content {
            flex-direction: column;
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            margin-right: 0;
            margin-bottom: 15px;
        }
        
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-group {
            min-width: auto;
        }
        
        .price-comparison-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">✅ Products Already in Your Store</h1>
                    <p class="text-muted mb-0">Review products that exist in both JDS and Shopify with pricing analysis</p>
                </div>
                <div>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        ← Back to Dashboard
                    </a>
                </div>
            </div>
            
            <!-- Search and Filters -->
            <div class="search-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Search Products</label>
                        <input type="text" id="search-input" class="form-control" placeholder="Search by name, SKU, or description...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Pricing Status</label>
                        <select id="pricing-filter" class="form-select">
                            <option value="">All Products</option>
                            <option value="accurate">Accurate Pricing</option>
                            <option value="underpriced">Underpriced</option>
                            <option value="overpriced">Overpriced</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Price Difference</label>
                        <select id="difference-filter" class="form-select">
                            <option value="">All Differences</option>
                            <option value="0-5">0% - 5%</option>
                            <option value="5-10">5% - 10%</option>
                            <option value="10-20">10% - 20%</option>
                            <option value="20+">Over 20%</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sort By</label>
                        <select id="sort-filter" class="form-select">
                            <option value="name">Product Name</option>
                            <option value="difference">Price Difference</option>
                            <option value="current_price">Current Price</option>
                            <option value="sku">SKU</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div>
                    <span id="total-count">0</span> products in your store
                </div>
                <div>
                    <span class="badge bg-success me-2" id="accurate-count">0</span> Accurate
                    <span class="badge bg-warning me-2" id="underpriced-count">0</span> Underpriced
                    <span class="badge bg-danger" id="overpriced-count">0</span> Overpriced
                </div>
            </div>
            
            <!-- Products Container -->
            <div id="products-container">
                {% if sync_required %}
                <div class="text-center py-5">
                    <div class="alert alert-warning">
                        <h4>No Products Found</h4>
                        <p>{{ message }}</p>
                        <p class="mb-3">In Vercel's serverless environment, the database is reset between deployments. You need to sync your data first.</p>
                        <div class="d-flex justify-content-center gap-3">
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                <i class="fas fa-sync"></i> Go to Dashboard to Sync
                            </a>
                            <button onclick="loadProducts()" class="btn btn-outline-primary">
                                <i class="fas fa-refresh"></i> Try Loading Again
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading products...</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global state
let allProducts = [];
let filteredProducts = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    setupEventListeners();
});

function setupEventListeners() {
    // Search input
    document.getElementById('search-input').addEventListener('input', debounce(filterProducts, 300));
    
    // Filters
    document.getElementById('pricing-filter').addEventListener('change', filterProducts);
    document.getElementById('difference-filter').addEventListener('change', filterProducts);
    document.getElementById('sort-filter').addEventListener('change', filterProducts);
    
    // Clickable price updates - event delegation for dynamically created elements
    function handlePriceActivation(el) {
        if (!el || el.classList.contains('is-busy')) return;
        const { sku, currentPrice, recommendedPrice } = el.dataset;
        if (sku && currentPrice && recommendedPrice) {
            updateProductPrice(sku, parseFloat(currentPrice), parseFloat(recommendedPrice), el);
        }
    }

    document.addEventListener('click', function(event) {
        const el = event.target.closest('.clickable-price');
        if (el) handlePriceActivation(el);
    });

    document.addEventListener('keydown', function(event) {
        const el = event.target.closest('.clickable-price');
        if (!el) return;
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            handlePriceActivation(el);
        }
    });
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function loadProducts() {
    try {
        const response = await fetch('/api/products/matched-with-pricing');
        const data = await response.json();
        
        if (data.success) {
            allProducts = data.products;
            filteredProducts = [...allProducts];
            updateStats();
            displayProducts();
        } else {
            showError('Failed to load products: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading products:', error);
        showError('Error loading products: ' + error.message);
    }
}

function filterProducts() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const pricingFilter = document.getElementById('pricing-filter').value;
    const differenceFilter = document.getElementById('difference-filter').value;
    const sortBy = document.getElementById('sort-filter').value;
    
    filteredProducts = allProducts.filter(product => {
        // Search filter
        const name = String(product.name || '');
        const sku = String(product.sku || '');
        const matchesSearch = !searchTerm || 
            name.toLowerCase().includes(searchTerm) ||
            sku.toLowerCase().includes(searchTerm) ||
            (product.description && product.description.toLowerCase().includes(searchTerm));
        
        // Pricing status filter
        let matchesPricing = true;
        if (pricingFilter) {
            const diffPercent = Math.abs(safeNumber(product.price_difference_percent));
            const priceDiff = safeNumber(product.price_difference);
            switch (pricingFilter) {
                case 'accurate':
                    matchesPricing = diffPercent <= 5;
                    break;
                case 'underpriced':
                    matchesPricing = priceDiff > 0 && diffPercent > 5;
                    break;
                case 'overpriced':
                    matchesPricing = priceDiff < 0 && diffPercent > 5;
                    break;
            }
        }
        
        // Price difference filter
        let matchesDifference = true;
        if (differenceFilter) {
            const diffPercent = Math.abs(safeNumber(product.price_difference_percent));
            switch (differenceFilter) {
                case '0-5':
                    matchesDifference = diffPercent <= 5;
                    break;
                case '5-10':
                    matchesDifference = diffPercent > 5 && diffPercent <= 10;
                    break;
                case '10-20':
                    matchesDifference = diffPercent > 10 && diffPercent <= 20;
                    break;
                case '20+':
                    matchesDifference = diffPercent > 20;
                    break;
            }
        }
        
        return matchesSearch && matchesPricing && matchesDifference;
    });
    
    // Sort products
    filteredProducts.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                const nameA = String(a.name || '');
                const nameB = String(b.name || '');
                return nameA.localeCompare(nameB);
            case 'difference':
                return Math.abs(safeNumber(b.price_difference_percent)) - Math.abs(safeNumber(a.price_difference_percent));
            case 'current_price':
                return safeNumber(b.current_shopify_price) - safeNumber(a.current_shopify_price);
            case 'sku':
                const skuA = String(a.sku || '');
                const skuB = String(b.sku || '');
                return skuA.localeCompare(skuB);
            default:
                return 0;
        }
    });
    
    updateStats();
    displayProducts();
}

function displayProducts() {
    const container = document.getElementById('products-container');
    
    if (filteredProducts.length === 0) {
        container.innerHTML = `
            <div class="no-products">
                <h3>No products found</h3>
                <p>Try adjusting your search or filter criteria.</p>
            </div>
        `;
        return;
    }
    
    try {
        container.innerHTML = filteredProducts.map(product => {
            try {
                return createProductCard(product);
            } catch (error) {
                console.error('Error creating product card for:', product.sku, error);
                return createErrorCard(product.sku, error.message).outerHTML;
            }
        }).join('');
    } catch (error) {
        console.error('Error displaying products:', error);
        container.innerHTML = '';
        container.appendChild(createErrorAlert(error.message));
    }
}

// Helper function to safely convert to number
function safeNumber(value, defaultValue = 0) {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? defaultValue : parsed;
}

// Helper function to escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper function to sanitize URLs to prevent attribute injection
function sanitizeUrl(url) {
    if (!url || typeof url !== 'string') {
        return '/static/images/placeholder.svg';
    }
    
    try {
        // Parse the URL to validate scheme
        const parsedUrl = new URL(url);
        
        // Whitelist allowed schemes
        const allowedSchemes = ['http:', 'https:', 'data:image/'];
        const isAllowedScheme = allowedSchemes.some(scheme => 
            parsedUrl.protocol === scheme || parsedUrl.protocol.startsWith(scheme)
        );
        
        if (!isAllowedScheme) {
            return '/static/images/placeholder.svg';
        }
        
        // Normalize and encode dangerous characters
        const normalizedUrl = parsedUrl.toString();
        
        // Check for dangerous characters that could break out of attributes
        const dangerousChars = /["'<>]/;
        if (dangerousChars.test(normalizedUrl)) {
            return '/static/images/placeholder.svg';
        }
        
        return normalizedUrl;
    } catch (error) {
        // If URL parsing fails, return placeholder
        return '/static/images/placeholder.svg';
    }
}

// Helper function to create safe error card
function createErrorCard(sku, errorMessage) {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    const paragraph = document.createElement('p');
    paragraph.textContent = `Error displaying product ${sku}: ${errorMessage}`;
    
    card.appendChild(paragraph);
    return card;
}

// Helper function to create safe error alert
function createErrorAlert(errorMessage) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger';
    alert.textContent = `Error displaying products: ${errorMessage}`;
    return alert;
}

// Helper function to safely call toFixed
function safeToFixed(value, decimals = 2) {
    const num = safeNumber(value);
    return num.toFixed(decimals);
}

function createProductCard(product) {
    try {
        const rawImageUrl = product.image_url || product.thumbnail_url || product.quick_image_url || '/static/images/placeholder.svg';
        const sanitizedUrl = sanitizeUrl(rawImageUrl);
        
        // Safely convert to numbers, handling null/undefined/string values
        const currentPrice = safeNumber(product.current_shopify_price);
        const calculatedPrice = safeNumber(product.calculated_shopify_price);
        const priceDiff = safeNumber(product.price_difference);
        const priceDiffPercent = safeNumber(product.price_difference_percent);
        const lessThanCasePrice = safeNumber(product.less_than_case_price);
    
    // Determine pricing status
    let pricingStatus = 'accurate';
    let statusClass = 'accurate';
    let statusText = 'Accurate';
    
    if (Math.abs(priceDiffPercent) > 5) {
        if (priceDiff > 0) {
            pricingStatus = 'underpriced';
            statusClass = 'underpriced';
            statusText = 'Underpriced';
        } else {
            pricingStatus = 'overpriced';
            statusClass = 'overpriced';
            statusText = 'Overpriced';
        }
    }
    
    return `
        <div class="product-card">
            <div class="product-header">
                <h3 class="product-title">${escapeHtml(product.name || 'Unnamed Product')}</h3>
                <div>
                    <span class="product-sku">${escapeHtml(product.sku)}</span>
                    <span class="status-badge ${statusClass} ms-2">${statusText}</span>
                </div>
            </div>
            
            <div class="product-content">
                <img src="${sanitizedUrl}" alt="${escapeHtml(product.name || 'Product')}" 
                     class="product-image" onerror="this.src='/static/images/placeholder.svg'">
                
                <div class="product-details">
                    <p class="product-description">${escapeHtml(product.description || 'No description available')}</p>
                    
                    <div class="pricing-comparison">
                        <div class="pricing-title">Pricing Comparison</div>
                        <div class="price-comparison-grid">
                            <div class="price-comparison-item current">
                                <div class="price-label">Current Shopify Price</div>
                                <div class="price-value">$${safeToFixed(currentPrice, 2)}</div>
                            </div>
                            <div class="price-comparison-item recommended clickable-price"
                                 role="button" tabindex="0"
                                 aria-label="Update price for SKU ${escapeHtml(product.sku)} to ${safeToFixed(calculatedPrice, 2)}"
                                 data-sku="${escapeHtml(product.sku)}" 
                                 data-current-price="${safeToFixed(currentPrice, 2)}" 
                                 data-recommended-price="${safeToFixed(calculatedPrice, 2)}"
                                 title="Click to update price to recommended value">
                                <div class="price-label">Recommended Price</div>
                                <div class="price-value">${safeToFixed(calculatedPrice, 2)}</div>
                                <div class="price-hint">Click to update</div>
                            </div>
                            <div class="price-comparison-item">
                                <div class="price-label">Difference</div>
                                <div class="price-value">$${safeToFixed(Math.abs(safeNumber(priceDiff)), 2)}</div>
                                <div class="price-difference ${priceDiff > 0 ? 'positive' : priceDiff < 0 ? 'negative' : 'neutral'}">
                                    ${priceDiff > 0 ? '+' : ''}${safeToFixed(priceDiffPercent, 1)}%
                                </div>
                            </div>
                            <div class="price-comparison-item">
                                <div class="price-label">JDS Base Price</div>
                                <div class="price-value">$${safeToFixed(lessThanCasePrice, 2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${product.pricing_warnings && product.pricing_warnings.length > 0 ? `
                        <div class="alert alert-warning alert-sm">
                            <strong>Pricing Note:</strong> ${product.pricing_warnings.join(', ')}
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    } catch (error) {
        console.error('Error creating product card for', product.sku, ':', error);
        return createErrorCard(product.sku, error.message).outerHTML;
    }
}

function updateStats() {
    document.getElementById('total-count').textContent = filteredProducts.length;
    
    // Count pricing statuses
    let accurate = 0, underpriced = 0, overpriced = 0;
    
    filteredProducts.forEach(product => {
        const diffPercent = Math.abs(safeNumber(product.price_difference_percent));
        const priceDiff = safeNumber(product.price_difference);
        
        if (diffPercent <= 5) {
            accurate++;
        } else if (priceDiff > 0) {
            underpriced++;
        } else {
            overpriced++;
        }
    });
    
    document.getElementById('accurate-count').textContent = accurate;
    document.getElementById('underpriced-count').textContent = underpriced;
    document.getElementById('overpriced-count').textContent = overpriced;
}

function showError(message) {
    // Use the existing alert system from main.js
    if (window.ProductAdder && window.ProductAdder.showAlert) {
        window.ProductAdder.showAlert('danger', message);
    } else {
        alert(message);
    }
}

async function updateProductPrice(sku, currentPrice, recommendedPrice) {
    // Show confirmation dialog
    const confirmed = showConfirmation(
        'Update Product Price',
        `Are you sure you want to update the price for SKU ${sku}?\n\n` +
        `Current Price: $${currentPrice.toFixed(2)}\n` +
        `New Price: $${recommendedPrice.toFixed(2)}\n\n` +
        `This will update the price in Shopify.`,
        'Update Price',
        'Cancel'
    );
    
    if (!confirmed) {
        return;
    }
    
    try {
        // Show loading state
        const priceElement = document.querySelector(`[data-sku="${sku}"].clickable-price`);
        if (priceElement) {
            priceElement.style.opacity = '0.6';
            priceElement.style.pointerEvents = 'none';
        }
        
        const response = await fetch('/api/products/update-single-price', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ sku: sku })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', `Price updated successfully for ${sku}: $${currentPrice.toFixed(2)} → $${recommendedPrice.toFixed(2)}`);
            
            // Reload products to show updated data
            await loadProducts();
        } else {
            showAlert('danger', `Failed to update price for ${sku}: ${data.error || 'Unknown error'}`);
            
            // Restore clickable state
            if (priceElement) {
                priceElement.style.opacity = '1';
                priceElement.style.pointerEvents = 'auto';
            }
        }
    } catch (error) {
        console.error('Error updating product price:', error);
        showAlert('danger', `Error updating price for ${sku}: ${error.message}`);
        
        // Restore clickable state
        if (priceElement) {
            priceElement.style.opacity = '1';
            priceElement.style.pointerEvents = 'auto';
        }
    }
}

function showConfirmation(title, message, confirmText = 'OK', cancelText = 'Cancel') {
    // Use browser's native confirm dialog for now
    // In a more sophisticated implementation, you could use a custom modal
    return confirm(`${title}\n\n${message}`);
}

function showAlert(type, message) {
    // Use the existing alert system from main.js
    if (window.ProductAdder && window.ProductAdder.showAlert) {
        window.ProductAdder.showAlert(type, message);
    } else {
        // Fallback to browser alert
        if (type === 'success') {
            alert('✅ ' + message);
        } else if (type === 'danger') {
            alert('❌ ' + message);
        } else {
            alert(message);
        }
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
