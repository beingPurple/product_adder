<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKU Search & Add - Product Adder</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 2.5em;
        }
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin: 0;
        }
        .search-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .search-section h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
        }
        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
        }
        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .btn.success { background: #27ae60; }
        .btn.success:hover { background: #229954; }
        .btn.danger { background: #e74c3c; }
        .btn.danger:hover { background: #c0392b; }
        .product-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f2f6;
        }
        .product-title {
            margin: 0;
            font-size: 1.5em;
            color: #2c3e50;
        }
        .product-sku {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .product-content {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .product-image {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 25px;
            border: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        
        .product-details {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .product-description {
            margin-bottom: 15px;
            line-height: 1.5;
            color: #555;
        }
        
        .product-info {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .info-item {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 6px;
            min-width: 120px;
        }
        .info-label {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .info-value {
            font-size: 1em;
            color: #2c3e50;
            font-weight: bold;
        }
        .pricing-section {
            background: white;
            padding: 0;
            border-radius: 0;
            margin-bottom: 20px;
        }
        .pricing-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .pricing-comparison {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .price-card {
            flex: 1;
            min-width: 140px;
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            transition: all 0.2s ease;
        }
        .price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .price-card.current-shopify {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .price-card.recommended {
            background: #e8f5e8;
            border-color: #4caf50;
            cursor: pointer;
        }
        .price-card.difference {
            background: #fafafa;
            border-color: #e0e0e0;
        }
        .price-card.jds-base {
            background: #fafafa;
            border-color: #e0e0e0;
        }
        .price-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .price-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        .price-percentage {
            font-size: 0.8em;
            color: #888;
        }
        .price-click-hint {
            font-size: 0.75em;
            color: #4caf50;
            font-style: italic;
        }
        .validation-errors {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .validation-errors.show {
            display: block;
        }
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .message {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .message.show {
            display: block;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .setup-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .setup-notice h3 {
            margin: 0 0 10px 0;
        }
        .setup-notice ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .setup-notice ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .setup-notice a {
            color: #856404;
            text-decoration: underline;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .product-content {
                flex-direction: column;
            }
            
            .product-image {
                width: 100%;
                height: 200px;
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            .product-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .pricing-comparison {
                flex-direction: column;
                gap: 10px;
            }
            
            .price-card {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç SKU Search & Add</h1>
            <p class="subtitle">Search for specific SKUs and add them to your Shopify store</p>
        </div>

        {% if setup_required %}
        <div class="setup-notice">
            <h3>‚ö†Ô∏è Setup Required</h3>
            <p>Your application is deployed but needs configuration. Please set up the following environment variables in your Vercel dashboard:</p>
            <ul>
                <li><strong>SHOPIFY_STORE</strong> - Your Shopify store domain (e.g., your-store.myshopify.com)</li>
                <li><strong>SHOPIFY_ACCESS_TOKEN</strong> - Your Shopify API access token</li>
                <li><strong>EXTERNAL_API_TOKEN</strong> - Your JDS API token</li>
                <li><strong>EXTERNAL_API_URL</strong> - JDS API URL (optional, has default)</li>
            </ul>
            <p><strong>How to set environment variables:</strong></p>
            <ol>
                <li>Go to your <a href="https://vercel.com/ppg0291s-projects/product_adder/settings" target="_blank">Vercel project settings</a></li>
                <li>Click on "Environment Variables" tab</li>
                <li>Add each variable with its value</li>
                <li>Redeploy your application</li>
            </ol>
        </div>
        {% endif %}

        <!-- SKU Search Section -->
        <div class="search-section">
            <h2>Search for Product by SKU</h2>
            <div class="search-form">
                <input type="text" 
                       id="skuInput" 
                       class="search-input"
                       placeholder="Enter SKU (e.g., LTM814, G2657)"
                       onkeypress="handleKeyPress(event)">
                <button class="btn" onclick="searchSKU()" id="searchBtn">
                    üîç Search SKU
                </button>
            </div>
            <p style="color: #7f8c8d; margin: 0; font-size: 0.9em;">
                Enter a SKU to search for product details and add it to your Shopify store
            </p>
        </div>

        <!-- Product Results Card -->
        <div id="productCard" class="product-card">
            <div class="product-header">
                <h3 id="productTitle" class="product-title">Product Name</h3>
                <span id="productSku" class="product-sku">SKU</span>
            </div>
            
            <div class="product-content">
                <img id="productImage" 
                     class="product-image" 
                     src="/static/images/placeholder.svg" 
                     alt="Product Image"
                     onerror="this.src='/static/images/placeholder.svg'">
                
                <div class="product-details">
                    <div id="productDescription" class="product-description">-</div>
                    
                    <div class="product-info">
                        <div class="info-item">
                            <div class="info-label">Available Quantity</div>
                            <div id="productAvailableQty" class="info-value">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Case Quantity</div>
                            <div id="productCaseQty" class="info-value">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pricing-section">
                <div class="pricing-title">Pricing Comparison</div>
                <div id="pricingComparison" class="pricing-comparison">
                    <!-- Pricing cards will be populated here -->
                </div>
                
                <!-- Loading Spinner and Success Note Section -->
                <div id="operationStatus" class="operation-status" style="display: none; margin: 20px 0; text-align: center;">
                    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div style="margin-top: 10px; color: #666; font-weight: 600;">Processing your request...</div>
                    </div>
                    <div id="successNote" class="success-note" style="display: none; background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; border: 1px solid #c3e6cb; margin-top: 10px;">
                        <div style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">‚úÖ Success!</div>
                        <div id="successMessage"></div>
                    </div>
                </div>
                
                <!-- Name Your Price Section -->
                <div class="name-your-price-section" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e1e8ed;">
                    <div class="pricing-title" style="margin-bottom: 15px;">Custom Pricing</div>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label for="customPrice" style="font-weight: 600; color: #2c3e50;">Name Your Price:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="color: #666; font-weight: bold;">$</span>
                                <input type="number" 
                                       id="customPrice" 
                                       step="0.01" 
                                       min="0" 
                                       placeholder="0.00"
                                       style="width: 100px; padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 6px; font-size: 16px; text-align: right;"
                                       onkeypress="handleCustomPriceKeyPress(event)">
                            </div>
                        </div>
                        <button class="btn btn-primary" 
                                id="customPriceBtn" 
                                onclick="addOrUpdateToShopifyWithCustomPrice()">
                            üí∞ Add with Custom Price
                        </button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        Enter your desired price and click the button to add/update the product in Shopify
                    </div>
                </div>
                
                <div id="validationErrors" class="validation-errors">
                    <strong>Validation Errors:</strong>
                    <ul id="validationErrorsList"></ul>
                </div>
            </div>

        </div>

        <div id="message-area"></div>
    </div>

    <script>
        // Global variables
        let currentProduct = null;

        // Handle Enter key press in search input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchSKU();
            }
        }

        // Handle Enter key press in custom price input
        function handleCustomPriceKeyPress(event) {
            if (event.key === 'Enter') {
                addOrUpdateToShopifyWithCustomPrice();
            }
        }

        // Show message to user
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const className = `message ${type}`;
            const div = document.createElement('div');
            div.className = className;
            div.textContent = message;
            messageArea.replaceChildren(div);
            div.classList.add('show');
            setTimeout(() => {
                div.classList.remove('show');
                setTimeout(() => messageArea.replaceChildren(), 300);
            }, 5000);
        }

        // Show loading spinner
        function showLoadingSpinner() {
            const operationStatus = document.getElementById('operationStatus');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const successNote = document.getElementById('successNote');
            
            operationStatus.style.display = 'block';
            loadingSpinner.style.display = 'block';
            successNote.style.display = 'none';
        }

        // Show success note
        function showSuccessNote(message) {
            const operationStatus = document.getElementById('operationStatus');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const successNote = document.getElementById('successNote');
            const successMessage = document.getElementById('successMessage');
            
            loadingSpinner.style.display = 'none';
            successMessage.textContent = message;
            successNote.style.display = 'block';
            
            // Hide success note after 5 seconds
            setTimeout(() => {
                operationStatus.style.display = 'none';
            }, 5000);
        }

        // Hide operation status
        function hideOperationStatus() {
            const operationStatus = document.getElementById('operationStatus');
            operationStatus.style.display = 'none';
        }

        // Search for SKU
        function searchSKU() {
            const skuInput = document.getElementById('skuInput');
            const searchBtn = document.getElementById('searchBtn');
            const sku = skuInput.value.trim();

            if (!sku) {
                showMessage('Please enter a SKU to search', 'error');
                return;
            }

            // Disable search button and show loading
            searchBtn.disabled = true;
            searchBtn.textContent = 'üîç Searching...';

            fetch('/api/sku/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ sku: sku })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentProduct = data.product;
                    displayProduct(data.product);
                    showMessage(`Found product: ${data.product.name}`, 'success');
                } else {
                    showMessage(data.message || 'Product not found', 'error');
                    hideProduct();
                }
            })
            .catch(error => {
                showMessage(`Search error: ${error.message}`, 'error');
                hideProduct();
            })
            .finally(() => {
                searchBtn.disabled = false;
                searchBtn.textContent = 'üîç Search SKU';
            });
        }

        // Poll for sync status updates
        function pollSyncStatus(sku) {
            if (!sku) return;
            
            fetch(`/api/sync/status/${sku}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update status based on sync result
                        if (data.status === 'completed') {
                            // Refresh the product data to get updated Shopify status
                            setTimeout(() => {
                                searchSKU();
                            }, 1000);
                        }
                        // Note: Status display removed - sync happens in background
                    }
                })
                .catch(error => {
                    console.error('Error polling sync status:', error);
                });
        }

        // Display product information
        function displayProduct(product) {
            const productCard = document.getElementById('productCard');
            const productTitle = document.getElementById('productTitle');
            const productSku = document.getElementById('productSku');
            const productImage = document.getElementById('productImage');
            const productDescription = document.getElementById('productDescription');
            const productCaseQty = document.getElementById('productCaseQty');
            const productAvailableQty = document.getElementById('productAvailableQty');

            // Update basic product info
            productTitle.textContent = product.name || 'Unknown Product';
            productSku.textContent = product.sku;
            productDescription.textContent = product.description || '-';
            productCaseQty.textContent = product.caseQuantity || '-';
            productAvailableQty.textContent = product.availableQuantity || '-';
            
            // Update product image with fallback handling
            const imageUrl = product.image_url || product.thumbnail_url || product.quick_image_url || '/static/images/placeholder.svg';
            productImage.src = imageUrl;
            productImage.alt = product.name || 'Product Image';

            // Shopify status display removed - sync happens in background

            // Update pricing information
            displayPricing(product);

            // Show the product card
            productCard.style.display = 'block';
            
            // Start polling for sync status if background sync is active
            if (product.background_sync_started) {
                const pollInterval = setInterval(() => {
                    pollSyncStatus(product.sku);
                }, 2000); // Poll every 2 seconds
                
                // Stop polling after 30 seconds or when sync completes
                setTimeout(() => {
                    clearInterval(pollInterval);
                }, 30000);
            }
        }

        // Display pricing information
        function displayPricing(product) {
            const pricingComparison = document.getElementById('pricingComparison');
            const validationErrors = document.getElementById('validationErrors');
            const validationErrorsList = document.getElementById('validationErrorsList');

            // Clear previous content
            pricingComparison.innerHTML = '';
            validationErrors.classList.remove('show');

            // Calculate current Shopify price and difference
            const currentShopifyPrice = product.current_shopify_price || 0;
            const recommendedPrice = product.recommended_price || 0;
            const difference = recommendedPrice - currentShopifyPrice;
            const differencePercent = currentShopifyPrice > 0 ? ((difference / currentShopifyPrice) * 100) : 0;
            const jdsBasePrice = product.lessThanCasePrice || 0;

            // Create pricing cards
            const pricingCards = [
                {
                    label: 'Current Shopify Price',
                    value: currentShopifyPrice,
                    className: 'current-shopify',
                    showValue: currentShopifyPrice > 0
                },
                {
                    label: 'Recommended Price',
                    value: recommendedPrice,
                    className: 'recommended',
                    showValue: true,
                    clickHint: currentShopifyPrice > 0 ? 'Click to update' : 'Add to Shopify',
                    clickable: true
                },
                {
                    label: 'Difference',
                    value: difference,
                    className: 'difference',
                    showValue: true,
                    showPercentage: true,
                    percentage: differencePercent
                },
                {
                    label: 'JDS Base Price',
                    value: jdsBasePrice,
                    className: 'jds-base',
                    showValue: true
                }
            ];

            pricingCards.forEach(card => {
                const priceCard = document.createElement('div');
                priceCard.className = `price-card ${card.className}`;
                
                // Make recommended price card clickable
                if (card.clickable) {
                    priceCard.style.cursor = 'pointer';
                    priceCard.addEventListener('click', () => addOrUpdateToShopify());
                }
                
                const label = document.createElement('div');
                label.className = 'price-label';
                label.textContent = card.label;
                
                const value = document.createElement('div');
                value.className = 'price-value';
                if (card.showValue) {
                    value.textContent = card.value ? `$${parseFloat(card.value).toFixed(2)}` : '$0.00';
                } else {
                    value.textContent = 'Not in Shopify';
                }
                
                priceCard.appendChild(label);
                priceCard.appendChild(value);

                // Add percentage for difference card
                if (card.showPercentage) {
                    const percentage = document.createElement('div');
                    percentage.className = 'price-percentage';
                    percentage.textContent = `${differencePercent.toFixed(1)}%`;
                    priceCard.appendChild(percentage);
                }

                // Add click hint for recommended price
                if (card.clickHint) {
                    const hint = document.createElement('div');
                    hint.className = 'price-click-hint';
                    hint.textContent = card.clickHint;
                    priceCard.appendChild(hint);
                }
                
                pricingComparison.appendChild(priceCard);
            });

            // Show validation errors if any
            if (product.pricing_errors && product.pricing_errors.length > 0) {
                validationErrors.classList.add('show');
                validationErrorsList.innerHTML = '';
                product.pricing_errors.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error;
                    validationErrorsList.appendChild(li);
                });
            }
        }


        // Add or update product to Shopify
        function addOrUpdateToShopify() {
            if (!currentProduct) {
                showMessage('No product selected', 'error');
                return;
            }

            const sku = currentProduct.sku;

            // Show loading spinner
            showLoadingSpinner();

            fetch('/api/sku/add-or-update-shopify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': '{{ api_key }}'
                },
                body: JSON.stringify({ sku: sku })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessNote(data.message);
                    // Update the product status and refresh display
                    if (data.action === 'added') {
                        currentProduct.already_in_shopify = true;
                        currentProduct.current_shopify_price = data.recommended_price;
                    } else if (data.action === 'updated') {
                        currentProduct.current_shopify_price = data.recommended_price;
                    }
                    displayProduct(currentProduct);
                } else {
                    hideOperationStatus();
                    showMessage(`Failed to add/update product: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                hideOperationStatus();
                showMessage(`Error adding/updating product: ${error.message}`, 'error');
            });
        }

        // Add or update product to Shopify with custom price
        function addOrUpdateToShopifyWithCustomPrice() {
            if (!currentProduct) {
                showMessage('No product selected', 'error');
                return;
            }

            const customPriceInput = document.getElementById('customPrice');
            const customPrice = parseFloat(customPriceInput.value);

            if (!customPrice || customPrice <= 0) {
                showMessage('Please enter a valid price greater than $0', 'error');
                customPriceInput.focus();
                return;
            }

            const sku = currentProduct.sku;

            // Show loading spinner
            showLoadingSpinner();

            fetch('/api/sku/add-or-update-shopify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': '{{ api_key }}'
                },
                body: JSON.stringify({ 
                    sku: sku,
                    custom_price: customPrice
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessNote(data.message);
                    // Update the product status and refresh display
                    if (data.action === 'added') {
                        currentProduct.already_in_shopify = true;
                        currentProduct.current_shopify_price = customPrice;
                    } else if (data.action === 'updated') {
                        currentProduct.current_shopify_price = customPrice;
                    }
                    displayProduct(currentProduct);
                    // Clear the custom price input
                    customPriceInput.value = '';
                } else {
                    hideOperationStatus();
                    showMessage(`Failed to add/update product: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                hideOperationStatus();
                showMessage(`Error adding/updating product: ${error.message}`, 'error');
            });
        }


        // Hide product card
        function hideProduct() {
            const productCard = document.getElementById('productCard');
            productCard.style.display = 'none';
            currentProduct = null;
        }
    </script>
</body>
</html>
