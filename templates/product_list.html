{% extends "base.html" %}

{% block title %}New Products Ready to Add - Product Adder{% endblock %}

{% block extra_head %}
<style>
    .product-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: white;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .product-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .product-card.selected {
        border-color: #007bff;
        background-color: #f8f9ff;
    }
    
    .product-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    
    .product-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin: 0;
        flex: 1;
    }
    
    .product-sku {
        background: #e9ecef;
        color: #495057;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .product-image {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 20px;
        border: 1px solid #e0e0e0;
    }
    
    .product-content {
        display: flex;
        margin-bottom: 15px;
    }
    
    .product-details {
        flex: 1;
    }
    
    .product-description {
        color: #666;
        margin-bottom: 10px;
        line-height: 1.5;
    }
    
    .pricing-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }
    
    .pricing-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }
    
    .price-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
    }
    
    .price-item {
        text-align: center;
        padding: 8px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e0e0e0;
    }
    
    .price-label {
        font-size: 0.75rem;
        color: #666;
        margin-bottom: 4px;
    }
    
    .price-value {
        font-weight: 600;
        color: #333;
    }
    
    .recommended-price {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    
    .bulk-actions {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 15px 30px;
        border-radius: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        display: none;
        z-index: 1000;
    }
    
    .bulk-actions.show {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .search-filters {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 200px;
    }
    
    .filter-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
    }
    
    .stats-bar {
        background: #e9ecef;
        padding: 10px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .no-products {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    
    .no-products h3 {
        margin-bottom: 10px;
        color: #333;
    }
    
    .checkbox-container {
        position: absolute;
        top: 15px;
        right: 15px;
    }
    
    .custom-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    @media (max-width: 768px) {
        .product-content {
            flex-direction: column;
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            margin-right: 0;
            margin-bottom: 15px;
        }
        
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-group {
            min-width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">üÜï New Products Ready to Add</h1>
                    <p class="text-muted mb-0">Discover products from JDS Wholesale that aren't in your Shopify store yet</p>
                </div>
                <div>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        ‚Üê Back to Dashboard
                    </a>
                </div>
            </div>
            
            <!-- Search and Filters -->
            <div class="search-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Search Products</label>
                        <input type="text" id="search-input" class="form-control" placeholder="Search by name, SKU, or description...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Price Range</label>
                        <select id="price-filter" class="form-select">
                            <option value="">All Prices</option>
                            <option value="0-10">Under $10</option>
                            <option value="10-25">$10 - $25</option>
                            <option value="25-50">$25 - $50</option>
                            <option value="50-100">$50 - $100</option>
                            <option value="100+">Over $100</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sort By</label>
                        <select id="sort-filter" class="form-select">
                            <option value="name">Product Name</option>
                            <option value="price">Recommended Price</option>
                            <option value="sku">SKU</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Items per page</label>
                        <select id="page-size" class="form-select">
                            <option value="10">10 per page</option>
                            <option value="25" selected>25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div>
                    <span id="total-count">0</span> products available
                    <span class="ms-3" id="selected-count" style="display: none;">
                        <span id="selected-number">0</span> selected
                    </span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="selectAll()">Select All</button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearSelection()">Clear All</button>
                </div>
            </div>
            
            <!-- Products Container -->
            <div id="products-container">
                <div class="text-center py-5">
                    <div class="spinner"></div>
                    <p class="mt-3">Loading products...</p>
                </div>
            </div>
            
            <!-- Pagination -->
            <nav aria-label="Product pagination" id="pagination-nav" style="display: none;">
                <ul class="pagination justify-content-center" id="pagination">
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Bulk Actions Bar -->
<div class="bulk-actions" id="bulk-actions">
    <span id="bulk-count">0 products selected</span>
    <button class="btn btn-primary" onclick="addSelectedProducts()">
        <i class="fas fa-plus"></i> Add to Shopify
    </button>
    <button class="btn btn-outline-secondary" onclick="clearSelection()">
        Clear Selection
    </button>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay" style="display: none;">
    <div class="text-center">
        <div class="spinner"></div>
        <p class="mt-3">Adding products to Shopify...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global state
let allProducts = [];
let filteredProducts = [];
let currentPage = 1;
let pageSize = 25;
let selectedProducts = new Set();

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    setupEventListeners();
});

function setupEventListeners() {
    // Search input
    document.getElementById('search-input').addEventListener('input', debounce(filterProducts, 300));
    
    // Filters
    document.getElementById('price-filter').addEventListener('change', filterProducts);
    document.getElementById('sort-filter').addEventListener('change', filterProducts);
    document.getElementById('page-size').addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1;
        displayProducts();
    });
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function loadProducts() {
    try {
        const response = await fetch('/api/products/unmatched');
        const data = await response.json();
        
        if (data.success) {
            allProducts = data.products;
            filteredProducts = [...allProducts];
            updateStats();
            displayProducts();
        } else {
            showError('Failed to load products: ' + data.error);
        }
    } catch (error) {
        showError('Error loading products: ' + error.message);
    }
}

function filterProducts() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const priceFilter = document.getElementById('price-filter').value;
    const sortBy = document.getElementById('sort-filter').value;
    
    filteredProducts = allProducts.filter(product => {
        // Search filter
        const matchesSearch = !searchTerm || 
            product.name.toLowerCase().includes(searchTerm) ||
            product.sku.toLowerCase().includes(searchTerm) ||
            (product.description && product.description.toLowerCase().includes(searchTerm));
        
        // Price filter
        let matchesPrice = true;
        if (priceFilter) {
            const price = product.recommended_price || 0;
            switch (priceFilter) {
                case '0-10':
                    matchesPrice = price < 10;
                    break;
                case '10-25':
                    matchesPrice = price >= 10 && price < 25;
                    break;
                case '25-50':
                    matchesPrice = price >= 25 && price < 50;
                    break;
                case '50-100':
                    matchesPrice = price >= 50 && price < 100;
                    break;
                case '100+':
                    matchesPrice = price >= 100;
                    break;
            }
        }
        
        return matchesSearch && matchesPrice;
    });
    
    // Sort products
    filteredProducts.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'price':
                return (b.recommended_price || 0) - (a.recommended_price || 0);
            case 'sku':
                return a.sku.localeCompare(b.sku);
            default:
                return 0;
        }
    });
    
    currentPage = 1;
    updateStats();
    displayProducts();
}

function displayProducts() {
    const container = document.getElementById('products-container');
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageProducts = filteredProducts.slice(startIndex, endIndex);
    
    if (pageProducts.length === 0) {
        container.innerHTML = `
            <div class="no-products">
                <h3>No products found</h3>
                <p>Try adjusting your search or filter criteria.</p>
            </div>
        `;
        document.getElementById('pagination-nav').style.display = 'none';
        return;
    }
    
    container.innerHTML = pageProducts.map(product => createProductCard(product)).join('');
    updatePagination();
    updateBulkActions();
}

function createProductCard(product) {
    const isSelected = selectedProducts.has(product.sku);
    const imageUrl = product.image_url || product.thumbnail_url || product.quick_image_url || '/static/images/placeholder.svg';
    
    return `
        <div class="product-card ${isSelected ? 'selected' : ''}" data-sku="${product.sku}">
            <div class="checkbox-container">
                <input type="checkbox" class="custom-checkbox" 
                       ${isSelected ? 'checked' : ''} 
                       onchange="toggleProductSelection('${product.sku}')">
            </div>
            
            <div class="product-header">
                <h3 class="product-title">${escapeHtml(product.name || 'Unnamed Product')}</h3>
                <span class="product-sku">${escapeHtml(product.sku)}</span>
            </div>
            
            <div class="product-content">
                <img src="${imageUrl}" alt="${escapeHtml(product.name || 'Product')}" 
                     class="product-image" onerror="this.src='/static/images/placeholder.svg'">
                
                <div class="product-details">
                    <p class="product-description">${escapeHtml(product.description || 'No description available')}</p>
                    
                    <div class="pricing-section">
                        <div class="pricing-title">Pricing Information</div>
                        <div class="price-grid">
                            <div class="price-item">
                                <div class="price-label">JDS Price</div>
                                <div class="price-value">$${(parseFloat(product.less_than_case_price) || 0).toFixed(2)}</div>
                            </div>
                            <div class="price-item recommended-price">
                                <div class="price-label">Recommended</div>
                                <div class="price-value">$${(parseFloat(product.recommended_price) || 0).toFixed(2)}</div>
                            </div>
                            <div class="price-item">
                                <div class="price-label">Case Qty</div>
                                <div class="price-value">${product.case_quantity || 'N/A'}</div>
                            </div>
                            <div class="price-item">
                                <div class="price-label">Available</div>
                                <div class="price-value">${product.available_quantity || 0}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${product.pricing_warnings && product.pricing_warnings.length > 0 ? `
                        <div class="alert alert-warning alert-sm">
                            <strong>Pricing Note:</strong> ${product.pricing_warnings.join(', ')}
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function toggleProductSelection(sku) {
    if (selectedProducts.has(sku)) {
        selectedProducts.delete(sku);
    } else {
        selectedProducts.add(sku);
    }
    
    // Update UI
    const card = document.querySelector(`[data-sku="${sku}"]`);
    if (card) {
        card.classList.toggle('selected', selectedProducts.has(sku));
    }
    
    updateBulkActions();
    updateStats();
}

function selectAll() {
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageProducts = filteredProducts.slice(startIndex, endIndex);
    
    pageProducts.forEach(product => {
        selectedProducts.add(product.sku);
    });
    
    displayProducts();
    updateBulkActions();
    updateStats();
}

function clearSelection() {
    selectedProducts.clear();
    displayProducts();
    updateBulkActions();
    updateStats();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulk-actions');
    const bulkCount = document.getElementById('bulk-count');
    
    if (selectedProducts.size > 0) {
        bulkActions.classList.add('show');
        bulkCount.textContent = `${selectedProducts.size} product${selectedProducts.size === 1 ? '' : 's'} selected`;
    } else {
        bulkActions.classList.remove('show');
    }
}

function updateStats() {
    document.getElementById('total-count').textContent = filteredProducts.length;
    
    const selectedCount = document.getElementById('selected-count');
    const selectedNumber = document.getElementById('selected-number');
    
    if (selectedProducts.size > 0) {
        selectedCount.style.display = 'inline';
        selectedNumber.textContent = selectedProducts.size;
    } else {
        selectedCount.style.display = 'none';
    }
}

function updatePagination() {
    const totalPages = Math.ceil(filteredProducts.length / pageSize);
    const pagination = document.getElementById('pagination');
    const paginationNav = document.getElementById('pagination-nav');
    
    if (totalPages <= 1) {
        paginationNav.style.display = 'none';
        return;
    }
    
    paginationNav.style.display = 'block';
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHTML;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredProducts.length / pageSize);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayProducts();
        window.scrollTo(0, 0);
    }
}

async function addSelectedProducts() {
    if (selectedProducts.size === 0) {
        showAlert('warning', 'Please select products to add');
        return;
    }
    
    const selectedSkus = Array.from(selectedProducts);
    
    // Show loading overlay
    document.getElementById('loading-overlay').style.display = 'flex';
    
    try {
        const result = await window.ProductAdder.addSelectedProducts(selectedSkus);
        
        if (result && result.success) {
            clearSelection();
            // Refresh the product list to remove added products
            loadProducts();
        }
        
    } catch (error) {
        showAlert('danger', 'Error adding products: ' + error.message);
    } finally {
        document.getElementById('loading-overlay').style.display = 'none';
    }
}

function showAlert(type, message) {
    // Use the existing alert system from main.js
    if (window.ProductAdder && window.ProductAdder.showAlert) {
        window.ProductAdder.showAlert(type, message);
    } else {
        alert(message);
    }
}

function showError(message) {
    showAlert('danger', message);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
